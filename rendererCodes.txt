------------------------------
FILE: app.js

const selectRepoBtn = document.getElementById('selectRepoBtn');
const activeRepoName = document.getElementById('activeRepoName');
const treeContainer = document.getElementById('treeContainer');
const structureBtn = document.getElementById('structureBtn');
const codeBtn = document.getElementById('codeBtn');
const generateBtn = document.getElementById('generateBtn');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

let selectedRepoPath = null;
let selectedItems = [];
let actionType = null; // "structure" or "code"

// ✅ Listen to progress updates from main process
window.electronAPI.onProgressUpdate((percent) => {
    progressBar.value = percent;
    progressText.textContent = `${percent}%`;
});

// Update active repo label
function updateActiveRepo(name) {
    activeRepoName.textContent = name;
}

// Handle repo selection
selectRepoBtn.addEventListener('click', async () => {
    const repoPath = await window.electronAPI.selectRepo();
    if (repoPath) {
        selectedRepoPath = repoPath;
        updateActiveRepo(repoPath);

        // Load folder tree
        const treeData = await window.electronAPI.getFolderTree(repoPath);
        displayTree(treeData, treeContainer);
    }
});

// Display tree recursively
function displayTree(tree, container) {
    container.innerHTML = '';
    function createNode(node) {
        const el = document.createElement('div');
        el.classList.add('tree-node');
        el.textContent = node.name;

        if (node.type === 'folder') {
            el.classList.add('folder');
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSelect(el, node);
            });
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.classList.add('children');
                node.children.forEach(child => {
                    childrenContainer.appendChild(createNode(child));
                });
                el.appendChild(childrenContainer);
            }
        } else {
            el.classList.add('file');
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSelect(el, node);
            });
        }
        return el;
    }

    tree.forEach(node => {
        container.appendChild(createNode(node));
    });
}

// Toggle selection
function toggleSelect(el, node) {
    if (selectedItems.includes(node.path)) {
        selectedItems = selectedItems.filter(p => p !== node.path);
        el.style.backgroundColor = '';
    } else {
        selectedItems.push(node.path);
        el.style.backgroundColor = '#d0f0d0';
    }
}

// Action buttons
structureBtn.addEventListener('click', () => actionType = 'structure');
codeBtn.addEventListener('click', () => actionType = 'code');

// ✅ Generate button now uses IPC progress event
generateBtn.addEventListener('click', async () => {
    if (!selectedRepoPath || selectedItems.length === 0 || !actionType) {
        alert('Select repo, items, and action first!');
        return;
    }

    const fileName = prompt('Enter output file name (e.g., UserModule.txt):');
    if (!fileName) return;

    progressBar.value = 0;
    progressText.textContent = '0%';

    // Call generate — progress handled by onProgressUpdate
    await window.electronAPI.generate(actionType, selectedRepoPath, selectedItems, fileName);

    alert('Done!');
    selectedItems = [];
});


