------------------------------
FILE: app.js

const selectRepoBtn = document.getElementById('selectRepoBtn');
const activeRepoName = document.getElementById('activeRepoName');
const treeContainer = document.getElementById('treeContainer');
const structureBtn = document.getElementById('structureBtn');
const codeBtn = document.getElementById('codeBtn');
const generateBtn = document.getElementById('generateBtn');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

let selectedRepoPath = null;
let selectedItems = [];
let actionType = 'code';

treeContainer.style.overflowY = 'auto';
treeContainer.style.maxHeight = '80vh';

window.electronAPI.onProgressUpdate((percent) => {
    progressBar.value = percent;
    progressText.textContent = `${percent}%`;
});

function updateActiveRepo(name) {
    activeRepoName.textContent = name || 'No repo selected';
}

async function loadLastActiveRepo() {
    const lastRepoPath = await window.electronAPI.getActiveProjectPath?.();
    if (!lastRepoPath) return;

    await loadRepo(lastRepoPath);
}

selectRepoBtn.addEventListener('click', async () => {
    const repoPath = await window.electronAPI.selectRepo();
    if (!repoPath) return;
    await loadRepo(repoPath);
});

async function loadRepo(repoPath) {
    selectedRepoPath = repoPath;
    const repoName = repoPath.split(/[/\\]/).pop();
    updateActiveRepo(repoName);
    const treeData = await window.electronAPI.getFolderTree(repoPath);

    selectedItems = await window.electronAPI.getLastSelected();

    displayTree(treeData, treeContainer, actionType);
}

function displayTree(tree, container, mode) {
    container.innerHTML = '';

    function createNode(node) {
        if (mode === 'structure' && node.type === 'file') return null;

        const el = document.createElement('div');
        el.classList.add('tree-node');
        el.style.cursor = 'pointer';
        el.style.paddingLeft = '16px';
        el.style.userSelect = 'none';
        el.style.fontSize = '14px';

        if (node.type === 'file') el.classList.add('file');
        if (selectedItems.includes(node.path)) el.classList.add('selected');

        if (
    selectedItems.includes(node.path) &&
    node.type === 'folder' &&
    actionType === 'code'
) {
    el.classList.add('folder-selected');
}


        let label = node.name;
        if (node.type === 'folder' && node.children?.length > 0 && mode !== 'structure') {
            const fileCount = countFiles(node);
            if (fileCount > 0) label += ` (${fileCount} files)`;
        }
        if (
    node.type === 'folder' &&
    actionType === 'code' &&
    selectedItems.includes(node.path)
) {
    label += ' [ALL FILES]';
}

el.textContent = label;


        el.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSelect(el, node);
        });

        if (node.type === 'folder' && node.children?.length > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.classList.add('children');
            childrenContainer.style.marginLeft = '16px';
            node.children.forEach(child => {
                const childNode = createNode(child);
                if (childNode) childrenContainer.appendChild(childNode);
            });
            el.appendChild(childrenContainer);
        }

        return el;
    }

    tree.forEach(node => {
        const n = createNode(node);
        if (n) container.appendChild(n);
    });
}

function countFiles(node) {
    if (node.type === 'file') return 1;
    if (!node.children?.length) return 0;
    return node.children.reduce((acc, child) => acc + countFiles(child), 0);
}

function toggleSelect(el, node) {
    const isSelected = selectedItems.includes(node.path);
generateBtn.disabled = selectedItems.length === 0;
    if (isSelected) {
        selectedItems = selectedItems.filter(p => p !== node.path);
        el.classList.remove('selected');
        el.classList.remove('folder-selected');
    } else {
        selectedItems.push(node.path);
        el.classList.add('selected');

        if (node.type === 'folder' && actionType === 'code') {
            el.classList.add('folder-selected');
        }
    }

   window.electronAPI.setLastSelected(selectedItems);

if (node.type === 'folder' && actionType === 'code') {
    window.electronAPI.getFolderTree(selectedRepoPath)
        .then(tree => displayTree(tree, treeContainer, actionType));
}

}

function resetSelection() {
    selectedItems = [];
    window.electronAPI.setLastSelected([]);
}generateBtn.disabled = true;


structureBtn.addEventListener('click', async () => {
    actionType = 'structure';
    resetSelection();

    if (!selectedRepoPath) return;

    const treeData = await window.electronAPI.getFolderTree(selectedRepoPath);
    displayTree(treeData, treeContainer, actionType);
});



codeBtn.addEventListener('click', async () => {
    actionType = 'code';
    resetSelection();

    if (!selectedRepoPath) return;

    const treeData = await window.electronAPI.getFolderTree(selectedRepoPath);
    displayTree(treeData, treeContainer, actionType);
});



generateBtn.addEventListener('click', async () => {
    if (!selectedRepoPath || !selectedItems.length) return alert('Select repo and items first!');
    const fileName = prompt('Enter output file name (e.g., UserModule.txt):');
    if (!fileName) return;

    progressBar.value = 0;
    progressText.textContent = '0%';

    await window.electronAPI.generate(actionType, selectedRepoPath, selectedItems, fileName);

    alert('Done!');
    selectedItems = [];
    const treeData = await window.electronAPI.getFolderTree(selectedRepoPath);
    displayTree(treeData, treeContainer, actionType);
});

// âœ… Only one DOMContentLoaded
window.addEventListener('DOMContentLoaded', loadLastActiveRepo);


